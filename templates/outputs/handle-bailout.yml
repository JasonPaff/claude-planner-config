# Handle quick-fix bailout
# Adds a comment to the work item when quick-fix can't complete

parameters:
  - name: workItemId
    type: string

steps:
  - script: |
      if [ "$(BAIL_OUT)" != "true" ]; then
        exit 0
      fi

      echo "Quick fix bailed out - adding comment to work item"

      # Get the user who triggered this (from work item changed by)
      CHANGED_BY=$(jq -r '.fields["System.ChangedBy"].uniqueName // "unknown"' $(Agent.TempDirectory)/work-item.json)

      COMMENT="AI QUICK FIX COULD NOT COMPLETE\n\nThe issue appears to be too complex for an automated quick fix.\n\nRecommendation: Move this item to 'AI Plan' status to generate a full implementation plan, or handle manually.\n\nTriggered by: $CHANGED_BY"

      # Add comment via API (URL-encode project name for spaces)
      PROJECT_ENCODED=$(echo "$(azureDevOpsProject)" | sed 's/ /%20/g')
      curl -s -X POST \
        -H "Authorization: Bearer $(System.AccessToken)" \
        -H "Content-Type: application/json" \
        -d "{\"text\": \"$COMMENT\"}" \
        "https://dev.azure.com/$(azureDevOpsOrg)/${PROJECT_ENCODED}/_apis/wit/workitems/${{ parameters.workItemId }}/comments?api-version=7.0-preview.3"

      echo "Comment added to work item"
    displayName: 'Handle quick-fix bail out'
    condition: eq(variables['BAIL_OUT'], 'true')
